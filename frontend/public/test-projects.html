<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projects API æµ‹è¯•</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
        .success { color: #52c41a; font-weight: bold; }
        .error { color: #ff4d4f; font-weight: bold; }
        .warning { color: #faad14; font-weight: bold; }
        button { background: #1890ff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        pre { background: #f6f6f6; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Projects API è¯Šæ–­å·¥å…·</h1>

    <div class="card">
        <h2>1. ç™»å½•è·å–Token</h2>
        <button onclick="login()">ç™»å½• (testuser/test123)</button>
        <div id="login-result"></div>
    </div>

    <div class="card">
        <h2>2. æµ‹è¯•API</h2>
        <button onclick="testProjectsAPI()">æµ‹è¯• /api/v1/user/projects</button>
        <button onclick="testWithRealToken()">ä½¿ç”¨å®é™…Tokenæµ‹è¯•</button>
        <div id="api-result"></div>
    </div>

    <div class="card">
        <h2>3. æ•°æ®ç»“æ„æ£€æŸ¥</h2>
        <button onclick="checkDataStructure()">æ£€æŸ¥æ•°æ®ç»“æ„</button>
        <div id="structure-result"></div>
    </div>

    <div class="card">
        <h2>4. è·³è½¬åˆ°åº”ç”¨</h2>
        <button onclick="goToApp()">å‰å¾€Projectsé¡µé¢</button>
    </div>

    <script>
        const API_BASE = 'http://localhost:8000';
        let storedToken = null;

        async function login() {
            const resultDiv = document.getElementById('login-result');
            resultDiv.innerHTML = '<p class="info">ç™»å½•ä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/api/v1/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: 'testuser',
                        password: 'test123'
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    storedToken = data.access_token;
                    localStorage.setItem('access_token', storedToken);

                    resultDiv.innerHTML = `
                        <p class="success">âœ… ç™»å½•æˆåŠŸ!</p>
                        <p>ç”¨æˆ·: ${data.user.username}</p>
                        <p>Token: ${storedToken.substring(0, 50)}...</p>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ ç™»å½•å¤±è´¥: ${data.detail}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }

        async function testProjectsAPI() {
            const resultDiv = document.getElementById('api-result');
            const token = localStorage.getItem('access_token');

            if (!token) {
                resultDiv.innerHTML = '<p class="warning">âš ï¸ è¯·å…ˆç™»å½•!</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="info">æµ‹è¯•APIä¸­...</p>';

            try {
                const response = await fetch(`${API_BASE}/api/v1/user/projects`, {
                    headers: { 'Authorization': token }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <p class="success">âœ… APIè°ƒç”¨æˆåŠŸ!</p>
                        <p>è·å–åˆ° ${data.length} ä¸ªAPI Keys</p>
                        <p>æ•°æ®ç±»å‹: ${Array.isArray(data) ? 'æ•°ç»„' : typeof data}</p>
                        <details>
                            <summary>æŸ¥çœ‹å®Œæ•´æ•°æ®</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ APIé”™è¯¯ (${response.status}): ${data.detail}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ ç½‘ç»œé”™è¯¯: ${error.message}</p>`;
            }
        }

        async function testWithRealToken() {
            const resultDiv = document.getElementById('api-result');

            // ä½¿ç”¨ä¸€ä¸ªå·²çŸ¥çš„æœ‰æ•ˆtoken
            const testToken = 'Bearer dXNlcl90ZXN0MDAxOjE3Njc0OTIwOTQuODAyODQy';

            resultDiv.innerHTML = '<p class="info">ä½¿ç”¨æµ‹è¯•Tokenæµ‹è¯•API...</p>';

            try {
                const response = await fetch(`${API_BASE}/api/v1/user/projects`, {
                    headers: { 'Authorization': testToken }
                });

                const data = await response.json();

                if (response.ok) {
                    resultDiv.innerHTML = `
                        <p class="success">âœ… APIè°ƒç”¨æˆåŠŸ!</p>
                        <p>è·å–åˆ° ${data.length} ä¸ªAPI Keys</p>
                        <p>ç¬¬ä¸€ä¸ªé¡¹ç›®çš„å­—æ®µ:</p>
                        <pre>${JSON.stringify(data[0], null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `<p class="error">âŒ APIé”™è¯¯: ${data.detail}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }

        async function checkDataStructure() {
            const resultDiv = document.getElementById('structure-result');
            const token = localStorage.getItem('access_token');

            if (!token) {
                resultDiv.innerHTML = '<p class="warning">âš ï¸ è¯·å…ˆç™»å½•!</p>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/user/projects`, {
                    headers: { 'Authorization': token }
                });

                const data = await response.json();

                if (response.ok && data.length > 0) {
                    const firstItem = data[0];
                    const fields = Object.keys(firstItem);

                    resultDiv.innerHTML = `
                        <p class="success">âœ… æ•°æ®ç»“æ„æ£€æŸ¥å®Œæˆ</p>
                        <p>å­—æ®µåˆ—è¡¨ (${fields.length}ä¸ª):</p>
                        <ul>
                            ${fields.map(f => `<li><code>${f}</code>: ${typeof firstItem[f]} = ${firstItem[f]}</li>`).join('')}
                        </ul>
                        <p class="info">
                            <strong>é‡è¦:</strong> æ³¨æ„å­—æ®µåæ˜¯è›‡å½¢å‘½å(api_key)è¿˜æ˜¯é©¼å³°å‘½å(apiKey)
                        </p>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">âŒ é”™è¯¯: ${error.message}</p>`;
            }
        }

        function goToApp() {
            window.location.href = '/usercenter/projects';
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦å·²æœ‰token
        window.onload = function() {
            if (localStorage.getItem('access_token')) {
                document.getElementById('login-result').innerHTML = '<p class="success">âœ… å·²æ£€æµ‹åˆ°Token,å¯ä»¥ç›´æ¥æµ‹è¯•API</p>';
            }
        };
    </script>
</body>
</html>
